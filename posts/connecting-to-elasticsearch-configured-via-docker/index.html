<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Thoughts on code and building things.">
    
    <link rel="shortcut icon" href="https://mottaquikarim.github.io/dev/favicon.ico">
    <link href="https://mottaquikarim.github.io/dev/fontawesome/css/all.min.css" rel="stylesheet">

    <style>
#post-header {
    text-align: center;
}
    </style>

    
    <link rel="stylesheet" href="/dev/css/style.min.css">

    <title>Connecting to Elasticsearch Configured via Docker</title>
    <script data-goatcounter="https://devtaqkarim.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
    
</head>
<body><header id="banner">
    
    <nav>
        <ul>
            <li>
                <a href="https://github.com/mottaquikarim" title="github" target="_blank"><i class='fab fa-github'></i></a>
            </li><li>
                <a href="https://www.linkedin.com/in/mottaqui-karim-5b01212a/" title="linkedin" target="_blank"><i class='fab fa-linkedin'></i></a>
            </li><li>
                <a href="https://twitter.com/taqkarim" title="twitter" target="_blank"><i class='fab fa-twitter'></i></a>
            </li>
        </ul>
    </nav>
    <nav>
        <ul>
            <li>
                <a href="/dev/" title="home">home</a>
            </li><li>
                <a href="/dev/about/" title="about">about</a>
            </li>
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>Connecting to Elasticsearch Configured via Docker</h1><time>March 16, 2020</time></header>

<aside id="toc">
    <h4>Table of Contents</h4>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#elastic-search-and-docker">Elastic Search and Docker</a></li>
<li><a href="#gotchas">Gotchas</a>
<ul>
<li><a href="#windows-elasticsearch-doesn-t-work">Windows: ElasticSearch doesn&rsquo;t work</a></li>
<li><a href="#even-after-changes-above-not-working">Even after changes above, not working</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</aside>


<h2 id="elastic-search-and-docker">Elastic Search and Docker</h2>

<p>Setting up an elasticsearch + kibana runtime is very easy to do with docker-compose:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>elasticsearch<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>docker.elastic.co/elasticsearch/elasticsearch<span class="p">:</span><span class="m">6.3</span>.<span class="m">2</span><span class="w">
</span><span class="w">    </span>environment<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>cluster.name=docker-cluster<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>bootstrap.memory_lock=<span class="kc">true</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span><span class="w">
</span><span class="w">    </span>ulimits<span class="p">:</span><span class="w">
</span><span class="w">      </span>memlock<span class="p">:</span><span class="w">
</span><span class="w">        </span>soft<span class="p">:</span><span class="w"> </span>-<span class="m">1</span><span class="w">
</span><span class="w">        </span>hard<span class="p">:</span><span class="w"> </span>-<span class="m">1</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;9200:9200&#34;</span><span class="w">
</span><span class="w">  </span>kibana<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>docker.elastic.co/kibana/kibana<span class="p">:</span><span class="m">6.3</span>.<span class="m">2</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;5601:5601&#34;</span></code></pre></div>
<p>For more information on the defaults (<code>ulimits</code> or <code>environment</code> variables, please see <a href="https://blog.k2datascience.com/running-elasticsearch-kibana-using-docker-5ff10ad017d0">this</a> post)</p>

<p>To run, you simply:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></div>
<p>And then navigate over to <a href="http://localhost:9200">http://localhost:9200</a> for elasticsearch or <a href="http://localhost:5601">http://localhost:5601</a> for kibana.</p>

<h2 id="gotchas">Gotchas</h2>

<p>As with all things, there may be some gotchas associated with this setup. Specifically, you may notice that sometimes navigating to the URLs referenced above will result in connection errors.</p>

<p>This can be for quite a few reasons, I&rsquo;ll list some common ones I&rsquo;ve encountered below.</p>

<h3 id="windows-elasticsearch-doesn-t-work">Windows: ElasticSearch doesn&rsquo;t work</h3>

<p>A few things to check - run a <code>docker ps -a</code> to ensure your container is running and for how long.</p>

<p>if it only lives for a few seconds, it may be due to a default <a href="https://stackoverflow.com/a/11685165"><code>max_map_count</code> issue</a>. To fix, if using <code>docker-machine</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker-machine ssh
sudo sysctl -w vm.max_map_count<span class="o">=</span><span class="m">262144</span>
exit</code></pre></div>
<p>If <em>not</em> using <code>docker-machine</code>, try:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker <span class="nb">exec</span> -it &lt;container_id&gt; /bin/bash
sysctl -w vm.max_map_count<span class="o">=</span><span class="m">262144</span></code></pre></div>
<p><em>NOTE</em>: this will not persist after container is killed. TO make it &ldquo;permanent&rdquo; you might want to:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">vi /etc/sysctl.conf
vm.max_map_count<span class="o">=</span><span class="m">262144</span></code></pre></div>
<p>(press <code>:q</code> to exit)</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">vi /etc/rc.local
<span class="nb">echo</span> <span class="m">262144</span> &gt; /proc/sys/vm/max_map_count</code></pre></div>
<p><a href="https://stackoverflow.com/a/53047291"><em>source</em></a></p>

<h3 id="even-after-changes-above-not-working">Even after changes above, not working</h3>

<p>One bit to note is that the docker container is simply wrapping the elasticsearch service. As such, sometimes it just takes a bit of time to load.</p>

<p>To ensure that elasticsearch is running properly, consider running:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose logs elasticsearch</code></pre></div>
<p>This will display the log messages emitted as elasticsearch is booted inside your container.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">example_elasticsearch <span class="p">|</span> <span class="o">[</span><span class="m">2020</span>-03-16T05:32:12,704<span class="o">][</span>INFO <span class="o">][</span>o.e.n.Node               <span class="o">]</span> <span class="o">[</span>IzFG4tZ<span class="o">]</span> initialized
example_elasticsearch <span class="p">|</span> <span class="o">[</span><span class="m">2020</span>-03-16T05:32:12,704<span class="o">][</span>INFO <span class="o">][</span>o.e.n.Node               <span class="o">]</span> <span class="o">[</span>IzFG4tZ<span class="o">]</span> starting ...
example_elasticsearch <span class="p">|</span> <span class="o">[</span><span class="m">2020</span>-03-16T05:32:12,959<span class="o">][</span>INFO <span class="o">][</span>o.e.t.TransportService   <span class="o">]</span> <span class="o">[</span>IzFG4tZ<span class="o">]</span> publish_address <span class="o">{</span><span class="m">172</span>.18.0.2:9300<span class="o">}</span>, bound_addresses <span class="o">{</span><span class="m">0</span>.0.0.0:9300<span class="o">}</span></code></pre></div>
<p>Once you see those three lines, you <em>should</em> be safe to attempt your &ldquo;healthcheck&rdquo; such as visiting <code>http://localhost:9200</code> in the browser or curling for it.</p>

<p>Alternatively, if something is foobar&rsquo;d you&rsquo;ll see it here which gives you further clues as to what went wrong.</p>

	    <h2>Share</h2>
	    <a href="https://twitter.com/intent/tweet?original_referer=https%3a%2f%2fmottaquikarim.github.io%2fdev%2fposts%2fconnecting-to-elasticsearch-configured-via-docker%2f&text=Check out this article by @taqkarim: https%3a%2f%2fmottaquikarim.github.io%2fdev%2fposts%2fconnecting-to-elasticsearch-configured-via-docker%2f" target="_blank"><i class="fab fa-twitter fa-2x"></i></a>
	    <a href="https://www.linkedin.com/shareArticle?mini=false&url=https%3a%2f%2fmottaquikarim.github.io%2fdev%2fposts%2fconnecting-to-elasticsearch-configured-via-docker%2f" target="_blank"><i class="fab fa-linkedin fa-2x"></i></a>
</article>

        </main><footer id="footer">
    Copyright Â© 2020 Taq Karim
</footer>
</body>
</html>
